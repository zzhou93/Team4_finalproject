---
title: "USDA database Analysis"
author: "Zirou Zhou, Xiaolan Wan, Lin Quan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{USDA database Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(unemployedR)
library(tidyverse)
library(usmap)
```



# Introduction

In this package, we want to introduce an easy method in visualization the economic data by geographic and time. We will use the USDA published unemployment and household income data as the original data source. Since it contains all the county, state and nation levels data from 2000 to 2022. And when visualization the data by geographic, we will the `usmap::us_map()` for each county's longitude and latitude.

Here are links to our github [repository](https://github.com/zzhou93/unemployedR) and [website](https://zzhou93.github.io/unemployedR).

# Functions

## Clean dara

In the data clean, we first read the CSV file from the [Unemployment and median household income for the U.S., States, and counties, 2000-20](https://www.ers.usda.gov/webdocs/DataFiles/48747/Unemployment.csv) by using the `read.csv()`.
```{r}
file<-read.csv("https://www.ers.usda.gov/webdocs/DataFiles/48747/Unemployment.csv")
head(file)
str(file)
```
The raw data contains all the economic information in one column `Attribute`, the structure of the `Attribute` is `Category_name_year`.First, since the year is always in form of `20xx`, we can use `dplyr::seperate(...,...,sep = -4)` to separate the `category` and `year`.
```{r}
file<-separate(file,Attribute,c("Attribute","year"),sep = -4)
head(file)
str(file)
```
Then we use the `table` to figure out what exactly economic information this data set provide.
```{r}
table(file$Attribute)
```
The government does not collect all the attributes annually. Only `Civilian_labor_force`, `Employed`, `Unemployed` and `Unemployment_rate` have been fully collected. And for some year, such as 2005 and 2006, they didn't collect all counties' data for each category. This may result some problem when we visualize the data later.
```{r}
#table(file$Attribute,file$year)
#vec1<-unique(filter(file,Attribute=="Unemployed_"&year==2005)$Area_name)
#Evec2<-unique(filter(file,Attribute=="Unemployed_"&year==2007)$Area_name)
#Evec2[!vec2 %in% vec1]
```
Other than `Attribute`, we also need to restructure the `state` and `Area_name` column. Since in this database, we have 3 level, the county, state and national data.
```{r}
unique(filter(file,State=="US")[2:3])
count(filter(file,State=="US")[2:3])

unique(filter(file,State=="NJ")[2:3])
count(filter(file,State=="NJ" & Area_name=="New Jersey")[2:3])
count(filter(file,State=="NJ" & !Area_name=="New Jersey")[2:3])

```
By the example of New Jersey, We find out, all national information is collected in the `State="US", Area_name="United States"`. The state level information is collected in `State= abbreviation , Area_name= full spelled`. The county data is collected in `State=abbreviation, Area_name=County name, Abbrevation`.

```{r}
setdiff(unique(file$State),unique(us_map("counties")$abbr))
```

### dataclean
```{r}
file=dataclean("https://www.ers.usda.gov/webdocs/DataFiles/48747/Unemployment.csv")
str(file)
```

## Mapping the data

### plotunemployed

```{r}
#about two pages?#
## The unemployment rate in county level for a specific state and a year
plotunemployed(file, 2018, "NJ")



```


### plotmedianhouseholdincome

```{r}

## 2019 median household income in county level for a specific state.
plotmedianhouseholdincome(file,"NJ")
```

### plotunemployed_animation


## Plotting the data

### plotunemployed_time

This function is used to plot the unemployment rate of selected state along with years.

The required aesthetics are:
  
- `file`: The clean up file from USDA site
- `local.name`: Selected state in the data. If it's not a vaild state name, it shows "Error! Not a state!"

The example shows unemployment rate in IA along with years.

```{r}
plotunemployed_time(file,"IA")
```

We use the state level data for this unemployment rate vs time plot. We also compared the state level unemployment rate with the whole nation, to figure out whether the chosen state has a different trend compared with the whole nation.

### stateunemployed

This function is used to plot top 10 unemployed county histogram in selected state and a year.

The required aesthetics are:
  
- `file`: The clean up file from USDA site
- `yr`: The selected year from 2000 to 202. If the year is out of range [2000, 2020], it shows "Error! Not a valid year!".
- `State.name`: Selected state in the data. If it's not a vaild state name, it shows "Error! Not a state!"

The example shows top 10 unemployed counties in IA in 2011 histogram.

```{r}
stateunemployed(file,2011,"IA")
```

We rank the top 10 counties in Iowa state. The histogram represent the unemployment population in each county, and later in shiny app, for each county we calculate the weight of this population in whole state.



